// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum RoleType {
    PARTICIPANT
    STAFF
    MODERATOR
    ADMIN

    @@map("role_type")
}

enum EducationLevel {
    M4
    M5
    M6
    Y1
    Y2
    Y3
    Y4
    GRADUATED
}

enum TransactionType {
    GIFT
    CODE_REDEMPTION
    CENTRAL_PAYMENT
    ADMIN_GRANT
    PEER_TRANSFER
}

model User {
    id              String         @id @db.Uuid
    studentId       String         @map("student_id")
    username        String
    nickname        String
    firstname       String
    lastname        String
    role            RoleType
    educationLevel  EducationLevel @map("education_level")
    school          String
    isResetUser     Boolean        @default(false) @map("is_reset_user")
    termsAcceptedAt DateTime?      @map("terms_accepted_at") @db.Timestamptz()
    wallets         Wallet         @relation(fields: [id], references: [user_id], onDelete: NoAction, onUpdate: NoAction, map: "users_id_fkey1")

    updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()
    createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

    senderTransactions Transaction[]   @relation("SenderTransactions")     // Represents transactions where THIS user is the SENDER
    recipientTransactions Transaction[] @relation("RecipientTransactions")  // Represents transactions where THIS user is the RECIPIENT


    @@unique([id])
    @@index([id])
    @@map("users")
}

model Wallet {
    user_id              String   @id @db.Uuid
    coin_balance         Int      @default(0)
    current_level        Int      @default(1)
    gift_sends_remaining Int      @default(5)
    updated_at           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz()
    last_gift_sent_at    DateTime @default(now()) @db.Timestamptz()
    users                User?

    @@index([coin_balance])
    @@map("wallets")
}

model Transaction {
    id                     Int @id @default(autoincrement())
    sender_user_id         String? @db.Uuid
    recipient_user_id      String? @db.Uuid
    type                   String
    coin_amount            Int
    exp_amount             Int
    related_code_id        Int?
    notes                  String?
    created_at             DateTime @default(now()) @db.Timestamptz()

    sender                 User? @relation("SenderTransactions", fields: [sender_user_id], references: [id])
    recipient              User? @relation("RecipientTransactions", fields: [recipient_user_id], references: [id])

    @@map("transactions")
}
